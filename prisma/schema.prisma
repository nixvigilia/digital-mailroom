generator client {
  provider   = "prisma-client"
  output     = "../app/generated/prisma"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

model Profile {
  id                String   @id @default(uuid()) @db.Uuid
  avatar_url        String?
  email             String   @unique
  referral_code     String?  @unique
  referred_by       String?  @db.Uuid
  updated_at        DateTime @updatedAt
  created_at        DateTime @default(now())
  user_type         UserType @default(INDIVIDUAL)
  role              UserRole @default(USER)
  password_hint     String?
  integration_email String?

  // Notification settings
  notify_new_mail  Boolean @default(true)
  notify_referrals Boolean @default(true)
  notify_marketing Boolean @default(false)

  // Mail settings
  default_forward_address String?
  shredding_pin_hash      String?

  business_account     BusinessAccount?
  kyc_verification     KYCVerification?
  backoffice_profile   BackofficeProfile?
  mail_action_requests MailActionRequest[]
  mail_items           MailItem[]
  subscriptions        Subscription[]
  payment_transactions PaymentTransaction[]
  team_memberships     TeamMember[]
  referrals            Referral[]           @relation("Referrer")
  referred_users       Referral[]           @relation("Referred")
  activity_logs        ActivityLog[]

  @@map("profile")
}

model BackofficeProfile {
  id         String   @id @default(uuid()) @db.Uuid
  profile_id String   @unique @db.Uuid
  first_name String
  last_name  String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  profile    Profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@map("backoffice_profile")
}

model ActivityLog {
  id          String   @id @default(uuid()) @db.Uuid
  profile_id  String   @db.Uuid
  action      String
  entity_type String?
  entity_id   String?
  details     Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())

  profile Profile @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@map("activity_log")
}

model KYCVerification {
  id                       String    @id @default(uuid()) @db.Uuid
  profile_id               String    @unique @db.Uuid
  first_name               String
  last_name                String
  date_of_birth            DateTime  @db.Date
  phone_number             String
  address                  String
  city                     String
  province                 String
  postal_code              String
  country                  String    @default("Philippines")
  id_type                  String
  id_file_front_url        String?
  id_file_back_url         String?
  consent_mail_opening     Boolean   @default(false)
  consent_data_processing  Boolean   @default(false)
  consent_terms_of_service Boolean   @default(false)
  consent_privacy_policy   Boolean   @default(false)
  status                   KYCStatus @default(NOT_STARTED)
  submitted_at             DateTime?
  reviewed_at              DateTime?
  reviewed_by              String?   @db.Uuid
  rejection_reason         String?
  created_at               DateTime  @default(now())
  updated_at               DateTime  @updatedAt
  profile                  Profile   @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@map("kyc_verification")
}

model BusinessAccount {
  id                             String       @id @default(uuid()) @db.Uuid
  profile_id                     String       @unique @db.Uuid
  business_name                  String
  business_type                  String?
  registration_number            String?
  tax_id                         String?
  business_address               String
  city                           String
  province                       String
  postal_code                    String
  country                        String       @default("Philippines")
  kyb_status                     KYBStatus    @default(NOT_STARTED)
  kyb_submitted_at               DateTime?
  kyb_reviewed_at                DateTime?
  kyb_reviewed_by                String?      @db.Uuid
  kyb_rejection_reason           String?
  business_registration_file_url String?
  tax_certificate_file_url       String?
  created_at                     DateTime     @default(now())
  updated_at                     DateTime     @updatedAt
  profile                        Profile      @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  mail_items                     MailItem[]
  team_members                   TeamMember[]

  @@map("business_account")
}

model TeamMember {
  id                  String           @id @default(uuid()) @db.Uuid
  profile_id          String           @db.Uuid
  business_account_id String           @db.Uuid
  role                String           @default("member")
  department          String?
  invitation_token    String?          @unique
  invitation_status   InvitationStatus @default(PENDING)
  invited_at          DateTime?
  joined_at           DateTime?
  created_at          DateTime         @default(now())
  updated_at          DateTime         @updatedAt
  business_account    BusinessAccount  @relation(fields: [business_account_id], references: [id], onDelete: Cascade)
  profile             Profile          @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@unique([profile_id, business_account_id])
  @@map("team_member")
}

model Package {
  id                  String         @id @default(uuid()) @db.Uuid
  name                String
  plan_type           String         @unique
  intended_for        String?
  cashback_percentage Decimal        @default(5.00) @db.Decimal(5, 2) // Default 5% referral fee
  description         String?
  price_monthly       Decimal        @db.Decimal(10, 2)
  price_quarterly     Decimal?       @db.Decimal(10, 2)
  price_yearly        Decimal?       @db.Decimal(10, 2)
  features            String[]
  not_included        String[]
  max_scanned_pages   Int?
  retention_days      Int?
  max_storage_items   Int?
  digital_storage_mb  Int?
  max_team_members    Int?
  is_active           Boolean        @default(true)
  is_featured         Boolean        @default(false)
  display_order       Int            @default(0)
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt
  created_by          String?        @db.Uuid
  subscriptions       Subscription[]

  @@map("package")
}

model Subscription {
  id                   String               @id @default(uuid()) @db.Uuid
  profile_id           String               @db.Uuid
  package_id           String?              @db.Uuid
  plan_type            String
  status               SubscriptionStatus   @default(ACTIVE)
  billing_cycle        BillingCycle         @default(MONTHLY)
  payment_method_id    String?
  next_billing_date    DateTime?
  last_payment_date    DateTime?
  started_at           DateTime             @default(now())
  expires_at           DateTime?
  cancelled_at         DateTime?
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt
  profile              Profile              @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  package              Package?             @relation(fields: [package_id], references: [id], onDelete: SetNull)
  payment_transactions PaymentTransaction[]

  // Mailing Location and Mailbox
  mailing_location_id String?          @db.Uuid
  mailing_location    MailingLocation? @relation(fields: [mailing_location_id], references: [id])

  mailbox_id String?  @db.Uuid
  mailbox    Mailbox? @relation(fields: [mailbox_id], references: [id])

  @@map("subscription")
}

model PaymentTransaction {
  id              String        @id @default(uuid()) @db.Uuid
  profile_id      String        @db.Uuid
  subscription_id String?       @db.Uuid
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("PHP")
  status          PaymentStatus @default(PENDING)
  external_id     String        @unique // Xendit Invoice ID or Reference ID
  invoice_url     String?
  payment_method  String?
  payment_channel String?
  paid_at         DateTime?
  expired_at      DateTime?
  description     String?
  metadata        Json?
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  profile         Profile       @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  subscription    Subscription? @relation(fields: [subscription_id], references: [id], onDelete: SetNull)

  @@map("payment_transaction")
}

model MailItem {
  id                    String              @id @default(uuid()) @db.Uuid
  profile_id            String?             @db.Uuid
  business_account_id   String?             @db.Uuid
  mailbox_id            String?             @db.Uuid
  sender                String
  subject               String?
  received_at           DateTime
  status                MailStatus          @default(RECEIVED)
  envelope_scan_url     String?
  full_scan_url         String?
  has_full_scan         Boolean             @default(false)
  tags                  String[]
  category              String?
  notes                 String?
  is_archived           Boolean             @default(false)
  assigned_to           String?             @db.Uuid
  department            String?
  requires_kyc_approval Boolean             @default(true)
  kyc_approved_at       DateTime?
  kyc_approved_by       String?             @db.Uuid
  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  action_requests       MailActionRequest[]
  business_account      BusinessAccount?    @relation(fields: [business_account_id], references: [id], onDelete: Cascade)
  profile               Profile?            @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  mailbox               Mailbox?            @relation(fields: [mailbox_id], references: [id], onDelete: SetNull)

  @@map("mail_item")
}

model MailActionRequest {
  id                      String       @id @default(uuid()) @db.Uuid
  mail_item_id            String       @db.Uuid
  profile_id              String       @db.Uuid
  action_type             ActionType
  status                  ActionStatus @default(PENDING)
  forward_address         String?
  forward_tracking_number String?
  forward_3pl_name        String?
  forward_tracking_url    String?
  notes                   String?
  requires_approval       Boolean      @default(true)
  approved_at             DateTime?
  approved_by             String?      @db.Uuid
  processed_at            DateTime?
  processed_by            String?      @db.Uuid
  completed_at            DateTime?
  created_at              DateTime     @default(now())
  updated_at              DateTime     @updatedAt
  mail_item               MailItem     @relation(fields: [mail_item_id], references: [id], onDelete: Cascade)
  profile                 Profile      @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@map("mail_action_request")
}

model MailingLocation {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  address     String
  city        String
  province    String
  postal_code String
  country     String  @default("Philippines")
  image_url   String?
  map_url     String?
  is_active   Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  clusters      MailboxCluster[]
  subscriptions Subscription[]

  @@map("mailing_location")
}

model MailboxCluster {
  id                  String  @id @default(uuid()) @db.Uuid
  mailing_location_id String  @db.Uuid
  name                String // e.g. "Cluster A", "CBU-1"
  description         String?

  mailing_location MailingLocation @relation(fields: [mailing_location_id], references: [id], onDelete: Cascade)
  mailboxes        Mailbox[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([mailing_location_id, name])
  @@map("mailbox_cluster")
}

model Mailbox {
  id             String        @id @default(uuid()) @db.Uuid
  cluster_id     String        @db.Uuid
  box_number     String
  type           MailboxType   @default(STANDARD)
  width          Decimal       @db.Decimal(10, 2)
  height         Decimal       @db.Decimal(10, 2)
  depth          Decimal       @db.Decimal(10, 2)
  dimension_unit DimensionUnit @default(CM)
  is_occupied    Boolean       @default(false)

  cluster MailboxCluster @relation(fields: [cluster_id], references: [id], onDelete: Cascade)

  // Inverse relation if we want to track which subscription owns this box
  subscriptions Subscription[]

  // Track all mail items received in this mailbox
  mail_items MailItem[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([cluster_id, box_number])
  @@map("mailbox")
}

model Referral {
  id                String                @id @default(uuid()) @db.Uuid
  referrer_id       String                @db.Uuid
  referred_id       String                @unique @db.Uuid
  referral_code     String
  subscription_plan String?
  created_at        DateTime              @default(now())
  updated_at        DateTime              @updatedAt
  referrer          Profile               @relation("Referrer", fields: [referrer_id], references: [id], onDelete: Cascade)
  referred          Profile               @relation("Referred", fields: [referred_id], references: [id], onDelete: Cascade)
  transactions      ReferralTransaction[]

  @@index([referrer_id])
  @@index([referral_code])
  @@map("referral")
}

model ReferralTransaction {
  id          String   @id @default(uuid()) @db.Uuid
  referral_id String   @db.Uuid
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("PHP")
  status      String   @default("paid") // paid, pending, void
  invoice_id  String? // payment invoice id
  description String?
  created_at  DateTime @default(now())
  referral    Referral @relation(fields: [referral_id], references: [id], onDelete: Cascade)

  @@map("referral_transaction")
}

model AllowedIP {
  id          String   @id @default(uuid()) @db.Uuid
  ip_address  String   @unique
  description String?
  created_at  DateTime @default(now())
  created_by  String?  @db.Uuid // Optional reference to the admin who added it

  @@map("allowed_ip")
}

enum UserType {
  INDIVIDUAL
  BUSINESS
  OPERATOR
  ADMIN
}

enum UserRole {
  USER
  BUSINESS_ADMIN
  TEAM_MEMBER
  OPERATOR
  KYC_APPROVER
  SYSTEM_ADMIN
}

enum KYCStatus {
  NOT_STARTED
  PENDING
  APPROVED
  REJECTED
}

enum KYBStatus {
  NOT_STARTED
  PENDING
  APPROVED
  REJECTED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum PlanType {
  BASIC
  PREMIUM
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  REFUNDED
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum MailStatus {
  RECEIVED
  SCANNED
  PROCESSED
  ARCHIVED
  FORWARDED
  SHREDDED
  DISPOSED
  HELD
}

enum ActionType {
  OPEN_AND_SCAN
  FORWARD
  SHRED
  HOLD
  DISPOSE
  ARCHIVE
}

enum ActionStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

enum MailboxType {
  STANDARD
  LARGE
  PARCEL_LOCKER
}

enum DimensionUnit {
  CM
  INCH
}
